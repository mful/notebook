var DiscussionBox=React.createClass({displayName:"DiscussionBox",getInitialState:function(){return{annotation:this.props.data.annotation,comments:this.props.data.comments}},componentWillReceiveProps:function(e){this.setState({annotation:e.annotation,comments:e.comments})},handleCommentSubmit:function(e){"undefined"==typeof this.state.annotation.id?this.createNew(e):this.addComment(e)},createNew:function(e){AnnotationActions.createWithComment({annotation:{text:this.props.data.annotation.text},url:this.props.data.annotation.url,comment:e})},addComment:function(e){AnnotationActions.addComment({annotation_id:this.state.annotation.id,comment:e})},componentDidMount:function(){AnnotationStore.addChangeListener(this._onChange),CommentStore.addChangeListener(this._onChange)},componentWillUnmount:function(){AnnotationStore.removeChangeListener(this._onChange),CommentStore.addChangeListener(this._onChange)},render:function(){return React.DOM.div({className:"discussion-box"},React.DOM.div({className:"new-comment"},CommentForm({form:this.props.data.form,onCommentSubmit:this.handleCommentSubmit})),HighlightText({highlight:this.state.annotation}),CommentList({comments:this.state.comments}),Menu(null))},_onChange:function(){var e,t;e=this.state.annotation.id?AnnotationStore.getById(this.state.annotation.id):AnnotationStore.getFirst(),t=e.id?CommentStore.getByAnnotationAsList(e.id):[],this.setState({annotation:e,comments:t})}}),HighlightText=React.createClass({displayName:"HighlightText",render:function(){return React.DOM.div({className:"highlight-text row"},React.DOM.blockquote({className:"small-12 column"},this.props.highlight.text,React.DOM.cite(null,this.props.highlight.base_domain)))}}),Comment=React.createClass({displayName:"Comment",replyForm:function(){return this.props.allowReply===!0?React.DOM.div({className:"row"},React.DOM.div({className:"small-12 column"},CommentReplyForm({commentId:this.props.key}))):void 0},render:function(){return React.DOM.div({className:"comment-wrapper"},React.DOM.div({className:"row"},React.DOM.div({className:"small-12 column"},React.DOM.div({className:"votes"},React.DOM.div({className:"vote clickable"},React.DOM.i({className:"ion-arrow-up-b"})),React.DOM.div({className:"vote clickable"},React.DOM.i({className:"ion-arrow-down-b"}))),React.DOM.p({className:"username"},this.props.author),React.DOM.p({className:"flag clickable"},React.DOM.i({className:"ion-flag"})))),React.DOM.div({className:"row comment"},React.DOM.div({className:"small-12 column"},React.DOM.p({className:"comment-content"},this.props.content))),this.replyForm())}}),CommentForm=React.createClass({displayName:"CommentForm",handleSubmit:function(e){e.preventDefault(),commentData={content:this.refs.content.getDOMNode().value.trim()},this.validate(commentData),this.props.onCommentSubmit(commentData)},validate:function(){return!0},resetForm:function(){this.refs.content.getDOMNode().value=""},componentDidMount:function(){CommentStore.addChangeListener(this.resetForm)},cancelButton:function(){return"function"==typeof this.props.onCancel?React.DOM.button({className:"button alt",onClick:this.props.onCancel},"Cancel"):void 0},render:function(){return React.DOM.form({className:"comment-form",id:"comment-form",onSubmit:this.handleSubmit},React.DOM.textarea({id:"comment_content",name:"comment[content]",placeholder:"What's on your mind?",ref:"content"}),React.DOM.button({className:"post-comment button",type:"submit"},"Post"),this.cancelButton())}}),CommentGroup=React.createClass({displayName:"CommentGroup",getInitialState:function(){return{comment:this.props.comment,replies:this.props.replies}},componentWillReceiveProps:function(e){this.setState({replies:e.replies})},render:function(){var e=this.state.replies.map(function(e){return Comment({author:e.author,content:e.content,key:e.id})});return React.DOM.div({className:"comment-group"},Comment({author:this.state.comment.author,content:this.state.comment.content,key:this.state.comment.id,allowReply:!0}),React.DOM.div({"class":"comment-replies"},e))}}),CommentList=React.createClass({displayName:"CommentList",getInitialState:function(){return{comments:this.props.comments}},componentWillReceiveProps:function(e){this.setState({comments:e.comments})},collectComments:function(){var e=this.state.comments.map(function(e){return CommentGroup({key:"commentGroup-"+e.id,comment:e,replies:e.replies})});return e},render:function(){return React.DOM.div({className:"commentList"},this.collectComments())}}),CommentReplyForm=React.createClass({displayName:"CommentReplyForm",getInitialState:function(){return{formVisible:!1}},toggleForm:function(e){return"undefined"!=typeof e&&e.preventDefault(),this.setState({formVisible:!this.state.formVisible})},submitReply:function(e){var t={reply:e,comment_id:this.props.commentId};return CommentActions.addReply(t),this.toggleForm()},contents:function(){return this.state.formVisible?CommentForm({onCommentSubmit:this.submitReply,onCancel:this.toggleForm}):React.DOM.div({ref:"reply-button",className:"comment-reply-button"},React.DOM.p({onClick:this.toggleForm,className:"button mini"},"Reply"))},render:function(){return this.contents()}}),EmailSignupForm=React.createClass({displayName:"EmailSignupForm",getInitialState:function(){return{login:!1,visible:this.props.visible,error:this.props.error}},componentWillReceiveProps:function(e){this.setState({login:this.state.login,visible:e.visible,error:e.error})},handleEmailSubmit:function(e){e.preventDefault();var t={email:this.refs.email.getDOMNode().value.trim(),password:this.refs.password.getDOMNode().value.trim()};this.state.login?SessionActions.emailLogin(t):(t.password_confirmation=this.refs.passwordConfirmation.getDOMNode().value.trim(),SessionActions.createUserWithEmail(t))},toggleLogin:function(){this.setState(this.state.login?{login:!1,error:!1}:{login:!0,error:!1})},visiblityClass:function(){return this.state.visible?"":"hidden"},loginClass:function(){return this.state.login?"":"hidden"},signupClass:function(){return this.state.login?"hidden":""},submitCTA:function(){return this.state.login?"Login":"Signup"},errorMessage:function(){return this.state.error?this.state.login?["Whoops! Login info doesn't match a Scribble user. Create Account instead?"]:SessionStore.userErrors():[]},render:function(){return React.DOM.div({id:"email-signup-form-component",className:this.visiblityClass()},FlashComponent({visible:this.state.error,type:"error",messages:this.errorMessage()}),React.DOM.form({id:"email-signup-form",onSubmit:this.handleEmailSubmit},React.DOM.input({ref:"email",type:"email",id:"user_email",name:"user[email]",placeholder:"email"}),React.DOM.input({ref:"password",type:"password",id:"user_password",name:"user[password]",placeholder:"password"}),React.DOM.input({ref:"passwordConfirmation",className:this.signupClass(),type:"password",id:"user_password_confirmation",name:"user[password_confirmation]",placeholder:"password one more time"}),React.DOM.button({type:"submit",id:"email-form-submit"},this.submitCTA())),React.DOM.p({className:"signup-login-toggle "+this.signupClass()},"Already have an account? ",React.DOM.span({className:"clickable email-login-toggler",onClick:this.toggleLogin},"Login")),React.DOM.p({className:"signup-login-toggle "+this.loginClass()},"New to these parts? ",React.DOM.span({className:"clickable email-login-toggler",onClick:this.toggleLogin},"Signup")),React.DOM.p({className:"clickable email-form-toggle",onClick:this.props.toggleHandler},"or connect with Facebook or Google"))}}),LoginForm=React.createClass({displayName:"LoginForm",getInitialState:function(){return null==this.props.header&&(this.props.header="Quick!"),null==this.props.subHeader&&(this.props.subHeader="Signup to post."),{emailSignup:!1,error:!1,header:this.props.header,subHeader:this.props.subHeader,username:!1}},toggleEmailForm:function(){this.setState({emailSignup:!this.state.emailSignup,error:!1})},getUsername:function(){this.setState({error:!1,header:"Last step!",subHeader:"Pick your username.",username:!0})},componentDidMount:function(){SessionStore.addChangeListener(this._onChange)},componentWillUnmount:function(){SessionStore.removeChangeListener(this._onChange)},render:function(){return React.DOM.div({id:"login-form-component"},React.DOM.div({id:"modal-header"},React.DOM.h2({id:"modal-header"},this.state.header),React.DOM.h4({className:"subheader"},this.state.subHeader)),UsernameInput({visible:this.state.username,error:this.state.error}),SocialConnectButtons({visible:!this.state.emailSignup&&!this.state.username,toggleHandler:this.toggleEmailForm}),EmailSignupForm({visible:this.state.emailSignup&&!this.state.username,toggleHandler:this.toggleEmailForm,error:this.state.error}),React.DOM.p({className:"privacy-policy"},"we hate spam too - check out our rock solid\xa0",React.DOM.a({target:"_blank",href:scribble.helpers.routes.privacy_policy_url()},"privacy policy")))},_onChange:function(){user=SessionStore.currentUser(),user&&user.id?null==user.username&&this.getUsername():this.setState({emailSignup:this.state.emailSignup,error:!0})}}),SocialConnectButtons=React.createClass({displayName:"SocialConnectButtons",getInitialState:function(){return{visible:this.props.visible}},componentWillReceiveProps:function(e){this.setState({visible:e.visible})},handleFbLogin:function(e){e.preventDefault(),SessionActions.fbLogin()},handleGoogleLogin:function(e){e.preventDefault(),SessionActions.googleLogin()},visibilityClass:function(){return this.state.visible?"":"hidden"},render:function(){return React.DOM.div({className:this.visibilityClass()},React.DOM.button({id:"fb-login",className:"fb-login",onClick:this.handleFbLogin},React.DOM.i({className:"ion-social-facebook"})," Connect With Facebook"),React.DOM.button({id:"google-login",className:"google-login",onClick:this.handleGoogleLogin},React.DOM.i({className:"ion-social-google"})," Connect With Google"),React.DOM.p({ref:"emailSignupLink",className:"clickable email-form-toggle",onClick:this.props.toggleHandler},"or signup with email"))}}),UsernameInput=React.createClass({displayName:"UsernameInput",getInitialState:function(){return{visible:this.props.visible,errors:this.props.error}},componentWillReceiveProps:function(e){this.setState({visible:e.visible})},visibilityClass:function(){return this.state.visible?"":"hidden"},errorMessage:function(){return this.state.error?SessionStore.userErrors():[]},submitUsername:function(e){e.preventDefault(),SessionActions.updateCurrentUser({username:this.refs.username.getDOMNode().value.trim()})},render:function(){return React.DOM.form({id:"username-select-component",className:this.visibilityClass(),onSubmit:this.submitUsername},FlashComponent({visible:this.state.error,type:"error",messages:this.errorMessage()}),React.DOM.input({name:"user[username]",id:"user_username",ref:"username",type:"text",placeholder:"pick your username"}),React.DOM.button({type:"submit"},"Finish"))}}),Menu=React.createClass({displayName:"Menu",handleLogout:function(){SessionActions.logout()},render:function(){return React.DOM.button({onClick:this.handleLogout},"logout")}}),FlashComponent=React.createClass({displayName:"FlashComponent",getInitialState:function(){return{type:this.props.type,messages:this.props.messages,visible:this.props.visible}},componentWillReceiveProps:function(e){this.setState({type:e.type,messages:e.messages,visible:e.visible})},getClasses:function(){var e=this.state.type;return this.state.visible||(e+=" hidden"),e},render:function(){var e=this.state.messages.map(function(e){return React.DOM.li(null,e)});return React.DOM.div({id:"flash-component",className:this.getClasses()},React.DOM.ul(null,e))}}),Modal=React.createClass({displayName:"Modal",maybeDismiss:function(e){e.target.id&&"scribble-modal"===e.target.id&&ModalActions.dismiss()},render:function(){return React.DOM.div({id:"scribble-modal",onClick:this.maybeDismiss},React.DOM.div({id:"scribble-modal-content"},this.props.component))}}),Bubble=React.createClass({displayName:"Bubble",getInitialState:function(){return this.props.server_rendered&&AppActions.initializeData({annotations:[this.props.annotation],comments:this.props.comments}),this.props},componentDidMount:function(){AnalyticsActions.trackAnnotationView(this.state.annotation,this.state.comments.length)},postMouseup:function(){var e={target:"bubble"};BubbleCourier.post(CourierConstants.POST_MOUSEUP,{event:e})},render:function(){return React.DOM.div({className:"bubble-component",onClick:this.postMouseup},CommentList({comments:this.state.comments,annotationId:this.props.annotation.id}))}}),Comment=React.createClass({displayName:"Comment",getInitialState:function(){return{content:this.props.comment.content,replyCount:this.props.comment.reply_count,score:this.props.comment.score,userVote:this.props.comment.current_user_vote}},componentWillReceiveProps:function(e){this.setState({content:e.comment.content,replyCount:e.comment.reply_count,score:e.comment.score,userVote:e.comment.current_user_vote})},addAnnotation:function(e){e.stopPropagation(),AnalyticsActions.trackAddAnnotation(),CommentActions.newComment(this.props.comment.annotation_id)},replyButtonText:function(){return 0===this.state.replyCount?"Reply":"Expand Replies ( "+this.state.replyCount+" )"},viewReplies:function(e){e.stopPropagation(),0===this.state.replyCount?CommentActions.newReply(this.props.comment.id):(AnalyticsActions.trackViewReplies(this.props.comment),CommentActions.showReplies(this.props.comment.id))},render:function(){return React.DOM.div({className:"comment-component","data-key":this.props.key},React.DOM.div({className:"votes-wrapper"},VotingBooth({score:this.state.score,userVote:this.state.userVote,commentId:this.props.comment.id})),React.DOM.div({className:"comment-content"},React.DOM.div({className:"row"},React.DOM.div({className:"small-12 column"},React.DOM.h6({className:"author"},this.props.comment.author))),React.DOM.div({className:"row"},React.DOM.div({className:"small-12 column"},React.DOM.p({className:"content"},this.state.content))),React.DOM.div({className:"comment-actions row"},React.DOM.div({className:"small-12 column"},React.DOM.div({className:"button tiny",onClick:this.addAnnotation},"Add Annotation"),React.DOM.div({className:"button tiny",onClick:this.viewReplies},this.replyButtonText())))))}}),CommentList=React.createClass({displayName:"CommentList",getInitialState:function(){return{comments:CommentStore.sortByRating(this.props.comments)}},componentWillReceiveProps:function(e){this.setState({comments:e.comments})},componentDidMount:function(){CommentStore.addChangeListener(this._onChange)},componentWillUnmount:function(){CommentStore.removeChangeListener(this._onChange)},componentDidUpdate:function(){var e;this.state.newComment&&(e=document.querySelector('.comment-component[data-key="'+this.state.newComment.id+'"]'),window.scroll(0,e.offsetTop))},collectComments:function(){return this.state.comments.map(function(e){return Comment({comment:e,key:e.id})})},render:function(){return React.DOM.div({className:"comment-list-component"},this.collectComments())},_onChange:function(){var e,t,s,n=CommentStore.getByAnnotationAsList(this.props.annotationId),i=!1;for(s=0;s<n.length;s++){for(i=!1,t=0;t<this.state.comments.length;t++)if(n[s].id===this.state.comments[t].id){i=!0;break}if(!i){e=n[s];break}}this.setState({comments:n,newComment:e})}}),VotingBooth=React.createClass({displayName:"VotingBooth",getInitialState:function(){return{score:this.props.score,userVote:this.props.userVote}},componentWillReceiveProps:function(e){return this.setState({score:e.score,userVote:e.userVote})},upVote:function(e){return e.stopPropagation(),"up"!==this.state.userVote?this.vote(!0):void 0},downVote:function(e){return e.stopPropagation(),"down"!==this.state.userVote?this.vote(!1):void 0},vote:function(e){return CommentActions.vote({id:this.props.commentId,positive:e})},voteClassName:function(e){var t="vote "+e+"-vote";return e===this.state.userVote?t+" active":t},render:function(){return React.DOM.div({className:"voting-booth-component"},React.DOM.div({className:"row"},React.DOM.div({className:"small-12 column"},React.DOM.div({className:this.voteClassName("up"),onClick:this.upVote}))),React.DOM.div({className:"row"},React.DOM.div({className:"small-12 column"},React.DOM.p({className:"vote-count"},this.state.score))),React.DOM.div({className:"row"},React.DOM.div({className:"small-12 column"},React.DOM.div({className:this.voteClassName("down"),onClick:this.downVote}))))}}),EmailSignupForm=React.createClass({displayName:"EmailSignupForm",getInitialState:function(){return{login:!1,visible:this.props.visible,error:this.props.error}},componentWillReceiveProps:function(e){this.setState({login:e.login,visible:e.visible,error:e.error})},handleEmailSubmit:function(e){e.preventDefault();var t={email:this.refs.email.getDOMNode().value.trim(),password:this.refs.password.getDOMNode().value.trim()};this.state.login?SessionActions.emailLogin(t):(t.password_confirmation=this.refs.passwordConfirmation.getDOMNode().value.trim(),SessionActions.createUserWithEmail(t))},toggleLogin:function(){this.setState({login:!this.state.login,error:!1})},visiblityClass:function(){return this.state.visible?"":"hidden"},loginClass:function(){return this.state.login?"":"hidden"},signupClass:function(){return this.state.login?"hidden":""},submitCTA:function(){return this.state.login?"Login":"Signup"},errorMessage:function(){return this.state.error?this.state.login?["Whoops! Login info doesn't match a Scribble user. Create Account instead?"]:SessionStore.userErrors():[]},toggleSocial:function(){this.props.toggleHandler()},render:function(){return React.DOM.div({className:"email-signup-form-component "+this.visiblityClass()},FlashComponent({visible:this.state.error,type:"error",messages:this.errorMessage()}),React.DOM.form({id:"email-signup-form",onSubmit:this.handleEmailSubmit},React.DOM.input({ref:"email",type:"email",id:"user_email",name:"user[email]",placeholder:"email"}),React.DOM.input({ref:"password",type:"password",id:"user_password",name:"user[password]",placeholder:"password"}),React.DOM.input({ref:"passwordConfirmation",className:this.signupClass(),type:"password",id:"user_password_confirmation",name:"user[password_confirmation]",placeholder:"password one more time"}),React.DOM.button({type:"submit",id:"email-form-submit"},this.submitCTA())),React.DOM.p({className:"signup-login-toggle "+this.signupClass()},"Already have an account? ",React.DOM.span({className:"clickable email-login-toggler",onClick:this.toggleLogin},"Login")),React.DOM.p({className:"signup-login-toggle "+this.loginClass()},"New to these parts? ",React.DOM.span({className:"clickable email-login-toggler",onClick:this.toggleLogin},"Signup")),React.DOM.p({className:"clickable email-form-toggle",onClick:this.toggleSocial},"or connect with Facebook or Google"))}}),FlashComponent=React.createClass({displayName:"FlashComponent",getInitialState:function(){return{type:this.props.type,messages:this.props.messages,visible:this.props.visible}},componentWillReceiveProps:function(e){this.setState({type:e.type,messages:e.messages,visible:e.visible})},getClasses:function(){var e=this.state.type;return this.state.visible||(e+=" hidden"),e},render:function(){var e=this.state.messages.map(function(e){return React.DOM.li(null,e)});return React.DOM.div({id:"flash-component",className:this.getClasses()},React.DOM.ul(null,e))}}),Janus=React.createClass({displayName:"Janus",getInitialState:function(){return this.props},componentDidMount:function(){AnalyticsActions.trackAuthStart(this.props.referringAction)},render:function(){return React.DOM.div({className:"janus-component"},LoginForm({subHeader:"Signup to "+this.state.referringAction}))}}),LoginForm=React.createClass({displayName:"LoginForm",getInitialState:function(){return null==this.props.header&&(this.props.header="Quick!"),null==this.props.subHeader&&(this.props.subHeader="Signup to post."),{emailSignup:!1,error:!1,header:this.props.header,subHeader:this.props.subHeader,username:!1}},toggleEmailForm:function(){this.setState({emailSignup:!this.state.emailSignup,error:!1})},getUsername:function(){this.setState({error:!1,header:"Last step!",subHeader:"Pick your username.",username:!0})},componentDidMount:function(){SessionStore.addChangeListener(this._onChange)},componentWillUnmount:function(){SessionStore.removeChangeListener(this._onChange)},render:function(){return React.DOM.div({className:"login-form-component"},React.DOM.div({id:"login-header"},React.DOM.h2({className:"header"},this.state.header),React.DOM.h4({className:"subheader"},this.state.subHeader)),UsernameInput({visible:this.state.username,error:this.state.error}),SocialConnectButtons({visible:!this.state.emailSignup&&!this.state.username,toggleHandler:this.toggleEmailForm}),EmailSignupForm({visible:this.state.emailSignup&&!this.state.username,toggleHandler:this.toggleEmailForm,error:this.state.error,login:!1}),React.DOM.p({className:"privacy-policy"},"we hate spam too - check out our rock solid\xa0",React.DOM.a({target:"_blank",href:scribble.helpers.routes.privacy_policy_url()},"privacy policy")))},_onChange:function(){user=SessionStore.currentUser(),user&&user.id?null==user.username&&this.getUsername():this.setState({emailSignup:this.state.emailSignup,error:!0})}}),SocialConnectButtons=React.createClass({displayName:"SocialConnectButtons",getInitialState:function(){return{visible:this.props.visible}},componentWillReceiveProps:function(e){this.setState({visible:e.visible})},handleFbLogin:function(e){e.preventDefault(),SessionActions.fbLogin()},handleGoogleLogin:function(e){e.preventDefault(),SessionActions.googleLogin()},visibilityClass:function(){return this.state.visible?"":"hidden"},render:function(){return React.DOM.div({className:"social-connect-buttons-component "+this.visibilityClass()},React.DOM.button({id:"fb-login",className:"fb-login button",onClick:this.handleFbLogin},React.DOM.i({className:"ion-social-facebook"})," Connect With Facebook"),React.DOM.button({id:"google-login",className:"google-login button",onClick:this.handleGoogleLogin},React.DOM.i({className:"ion-social-google"})," Connect With Google"),React.DOM.p({ref:"emailSignupLink",className:"clickable email-form-toggle",onClick:this.props.toggleHandler},"or signup with email"))}}),UsernameInput=React.createClass({displayName:"UsernameInput",getInitialState:function(){return{visible:this.props.visible,errors:this.props.error}},componentWillReceiveProps:function(e){this.setState({visible:e.visible})},visibilityClass:function(){return this.state.visible?"":"hidden"},errorMessage:function(){return this.state.error?SessionStore.userErrors():[]},submitUsername:function(e){e.preventDefault(),SessionActions.updateCurrentUser({username:this.refs.username.getDOMNode().value.trim()})},render:function(){return React.DOM.form({id:"username-select-component",className:this.visibilityClass(),onSubmit:this.submitUsername},FlashComponent({visible:this.state.error,type:"error",messages:this.errorMessage()}),React.DOM.input({name:"user[username]",id:"user_username",ref:"username",type:"text",placeholder:"pick your username"}),React.DOM.button({type:"submit",className:"button"},"Finish"))}}),CommentForm=React.createClass({displayName:"CommentForm",submitHandler:function(e){e.preventDefault(),e.stopPropagration(),this.props.submitHandler(this.refs.content.getDOMNode().value)},render:function(){return React.DOM.form({className:"comment-form-component",onSubmit:this.submitHandler},React.DOM.div({className:"row"},React.DOM.div({className:"small-12 column"},React.DOM.textarea({rows:"6",ref:"content"}))),React.DOM.div({className:"row actions"},React.DOM.div({className:"small-12 column"},React.DOM.input({type:"submit",className:"button tiny"}))))}}),Paper=React.createClass({displayName:"Paper",getInitialState:function(){return this.props},submitHandler:function(e){"comment"===this.props.type?CommentActions.createComment({annotation_id:this.props.id,comment:{content:e}}):"annotation"===this.props.type?AnnotationActions.createWithComment({annotation:{text:this.props.text},url:this.props.url,comment:{content:e}}):"reply"===this.props.type&&CommentActions.createReply({comment_id:this.props.id,reply:{content:e}})},postMouseup:function(){var e={target:"paper"};PaperCourier.post(CourierConstants.POST_MOUSEUP,{event:e})},render:function(){return React.DOM.div({className:"paper-component",onClick:this.postMouseup},CommentForm({submitHandler:this.submitHandler}))}});