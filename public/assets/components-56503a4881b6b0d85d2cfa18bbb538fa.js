var DiscussionBox=React.createClass({displayName:"DiscussionBox",getInitialState:function(){return{annotation:this.props.data.annotation,comments:this.props.data.comments}},componentWillReceiveProps:function(t){this.setState({annotation:t.annotation,comments:t.comments})},handleCommentSubmit:function(t){"undefined"==typeof this.state.annotation.id?this.createNew(t):this.addComment(t)},createNew:function(t){AnnotationActions.createWithComment({annotation:{text:this.props.data.annotation.text},url:this.props.data.annotation.url,comment:t})},addComment:function(t){AnnotationActions.addComment({annotation_id:this.state.annotation.id,comment:t})},componentDidMount:function(){AnnotationStore.addChangeListener(this._onChange),CommentStore.addChangeListener(this._onChange)},componentWillUnmount:function(){AnnotationStore.removeChangeListener(this._onChange),CommentStore.addChangeListener(this._onChange)},render:function(){return React.DOM.div({className:"discussion-box"},React.DOM.div({className:"new-comment"},CommentForm({form:this.props.data.form,onCommentSubmit:this.handleCommentSubmit})),HighlightText({highlight:this.state.annotation}),CommentList({comments:this.state.comments}),Menu(null))},_onChange:function(){var t,e;t=this.state.annotation.id?AnnotationStore.getById(this.state.annotation.id):AnnotationStore.getFirst(),e=t.id?CommentStore.getByAnnotationAsList(t.id):[],this.setState({annotation:t,comments:e})}}),HighlightText=React.createClass({displayName:"HighlightText",render:function(){return React.DOM.div({className:"highlight-text row"},React.DOM.blockquote({className:"small-12 column"},this.props.highlight.text,React.DOM.cite(null,this.props.highlight.base_domain)))}}),Comment=React.createClass({displayName:"Comment",replyForm:function(){return this.props.allowReply===!0?React.DOM.div({className:"row"},React.DOM.div({className:"small-12 column"},CommentReplyForm({commentId:this.props.key}))):void 0},render:function(){return React.DOM.div({className:"comment-wrapper"},React.DOM.div({className:"row"},React.DOM.div({className:"small-12 column"},React.DOM.div({className:"votes"},React.DOM.div({className:"vote clickable"},React.DOM.i({className:"ion-arrow-up-b"})),React.DOM.div({className:"vote clickable"},React.DOM.i({className:"ion-arrow-down-b"}))),React.DOM.p({className:"username"},this.props.author),React.DOM.p({className:"flag clickable"},React.DOM.i({className:"ion-flag"})))),React.DOM.div({className:"row comment"},React.DOM.div({className:"small-12 column"},React.DOM.p({className:"comment-content"},this.props.content))),this.replyForm())}}),CommentForm=React.createClass({displayName:"CommentForm",handleSubmit:function(t){t.preventDefault(),commentData={content:this.refs.content.getDOMNode().value.trim()},this.validate(commentData),this.props.onCommentSubmit(commentData)},validate:function(){return!0},resetForm:function(){this.refs.content.getDOMNode().value=""},componentDidMount:function(){CommentStore.addChangeListener(this.resetForm)},cancelButton:function(){return"function"==typeof this.props.onCancel?React.DOM.button({className:"button alt",onClick:this.props.onCancel},"Cancel"):void 0},render:function(){return React.DOM.form({className:"comment-form",id:"comment-form",onSubmit:this.handleSubmit},React.DOM.textarea({id:"comment_content",name:"comment[content]",placeholder:"What's on your mind?",ref:"content"}),React.DOM.button({className:"post-comment button",type:"submit"},"Post"),this.cancelButton())}}),CommentGroup=React.createClass({displayName:"CommentGroup",getInitialState:function(){return{comment:this.props.comment,replies:this.props.replies}},componentWillReceiveProps:function(t){this.setState({replies:t.replies})},render:function(){var t=this.state.replies.map(function(t){return Comment({author:t.author,content:t.content,key:t.id})});return React.DOM.div({className:"comment-group"},Comment({author:this.state.comment.author,content:this.state.comment.content,key:this.state.comment.id,allowReply:!0}),React.DOM.div({"class":"comment-replies"},t))}}),CommentList=React.createClass({displayName:"CommentList",getInitialState:function(){return{comments:this.props.comments}},componentWillReceiveProps:function(t){this.setState({comments:t.comments})},collectComments:function(){var t=this.state.comments.map(function(t){return CommentGroup({key:"commentGroup-"+t.id,comment:t,replies:t.replies})});return t},render:function(){return React.DOM.div({className:"commentList"},this.collectComments())}}),CommentReplyForm=React.createClass({displayName:"CommentReplyForm",getInitialState:function(){return{formVisible:!1}},toggleForm:function(t){return"undefined"!=typeof t&&t.preventDefault(),this.setState({formVisible:!this.state.formVisible})},submitReply:function(t){var e={reply:t,comment_id:this.props.commentId};return CommentActions.addReply(e),this.toggleForm()},contents:function(){return this.state.formVisible?CommentForm({onCommentSubmit:this.submitReply,onCancel:this.toggleForm}):React.DOM.div({ref:"reply-button",className:"comment-reply-button"},React.DOM.p({onClick:this.toggleForm,className:"button mini"},"Reply"))},render:function(){return this.contents()}}),EmailSignupForm=React.createClass({displayName:"EmailSignupForm",getInitialState:function(){return{login:!1,visible:this.props.visible,error:this.props.error}},componentWillReceiveProps:function(t){this.setState({login:this.state.login,visible:t.visible,error:t.error})},handleEmailSubmit:function(t){t.preventDefault();var e={email:this.refs.email.getDOMNode().value.trim(),password:this.refs.password.getDOMNode().value.trim()};this.state.login?SessionActions.emailLogin(e):(e.password_confirmation=this.refs.passwordConfirmation.getDOMNode().value.trim(),SessionActions.createUserWithEmail(e))},toggleLogin:function(){this.setState(this.state.login?{login:!1,error:!1}:{login:!0,error:!1})},visiblityClass:function(){return this.state.visible?"":"hidden"},loginClass:function(){return this.state.login?"":"hidden"},signupClass:function(){return this.state.login?"hidden":""},submitCTA:function(){return this.state.login?"Login":"Signup"},errorMessage:function(){return this.state.error?this.state.login?["Whoops! Login info doesn't match a Scribble user. Create Account instead?"]:SessionStore.userErrors():[]},render:function(){return React.DOM.div({id:"email-signup-form-component",className:this.visiblityClass()},FlashComponent({visible:this.state.error,type:"error",messages:this.errorMessage()}),React.DOM.form({id:"email-signup-form",onSubmit:this.handleEmailSubmit},React.DOM.input({ref:"email",type:"email",id:"user_email",name:"user[email]",placeholder:"email"}),React.DOM.input({ref:"password",type:"password",id:"user_password",name:"user[password]",placeholder:"password"}),React.DOM.input({ref:"passwordConfirmation",className:this.signupClass(),type:"password",id:"user_password_confirmation",name:"user[password_confirmation]",placeholder:"password one more time"}),React.DOM.button({type:"submit",id:"email-form-submit"},this.submitCTA())),React.DOM.p({className:"signup-login-toggle "+this.signupClass()},"Already have an account? ",React.DOM.span({className:"clickable email-login-toggler",onClick:this.toggleLogin},"Login")),React.DOM.p({className:"signup-login-toggle "+this.loginClass()},"New to these parts? ",React.DOM.span({className:"clickable email-login-toggler",onClick:this.toggleLogin},"Signup")),React.DOM.p({className:"clickable email-form-toggle",onClick:this.props.toggleHandler},"or connect with Facebook or Google"))}}),LoginForm=React.createClass({displayName:"LoginForm",getInitialState:function(){return null==this.props.header&&(this.props.header="Quick!"),null==this.props.subHeader&&(this.props.subHeader="Signup to post."),{emailSignup:!1,error:!1,header:this.props.header,subHeader:this.props.subHeader,username:!1}},toggleEmailForm:function(){this.setState({emailSignup:!this.state.emailSignup,error:!1})},getUsername:function(){this.setState({error:!1,header:"Last step!",subHeader:"Pick your username.",username:!0})},componentDidMount:function(){SessionStore.addChangeListener(this._onChange)},componentWillUnmount:function(){SessionStore.removeChangeListener(this._onChange)},render:function(){return React.DOM.div({id:"login-form-component"},React.DOM.div({id:"modal-header"},React.DOM.h2({id:"modal-header"},this.state.header),React.DOM.h4({className:"subheader"},this.state.subHeader)),UsernameInput({visible:this.state.username,error:this.state.error}),SocialConnectButtons({visible:!this.state.emailSignup&&!this.state.username,toggleHandler:this.toggleEmailForm}),EmailSignupForm({visible:this.state.emailSignup&&!this.state.username,toggleHandler:this.toggleEmailForm,error:this.state.error}),React.DOM.p({className:"privacy-policy"},"we hate spam too - check out our rock solid\xa0",React.DOM.a({target:"_blank",href:scribble.helpers.routes.privacy_policy_url()},"privacy policy")))},_onChange:function(){user=SessionStore.currentUser(),user&&user.id?null==user.username&&this.getUsername():this.setState({emailSignup:this.state.emailSignup,error:!0})}}),SocialConnectButtons=React.createClass({displayName:"SocialConnectButtons",getInitialState:function(){return{visible:this.props.visible}},componentWillReceiveProps:function(t){this.setState({visible:t.visible})},handleFbLogin:function(t){t.preventDefault(),SessionActions.fbLogin()},handleGoogleLogin:function(t){t.preventDefault(),SessionActions.googleLogin()},visibilityClass:function(){return this.state.visible?"":"hidden"},render:function(){return React.DOM.div({className:this.visibilityClass()},React.DOM.button({id:"fb-login",className:"fb-login",onClick:this.handleFbLogin},React.DOM.i({className:"ion-social-facebook"})," Connect With Facebook"),React.DOM.button({id:"google-login",className:"google-login",onClick:this.handleGoogleLogin},React.DOM.i({className:"ion-social-google"})," Connect With Google"),React.DOM.p({ref:"emailSignupLink",className:"clickable email-form-toggle",onClick:this.props.toggleHandler},"or signup with email"))}}),UsernameInput=React.createClass({displayName:"UsernameInput",getInitialState:function(){return{visible:this.props.visible,errors:this.props.error}},componentWillReceiveProps:function(t){this.setState({visible:t.visible})},visibilityClass:function(){return this.state.visible?"":"hidden"},errorMessage:function(){return this.state.error?SessionStore.userErrors():[]},submitUsername:function(t){t.preventDefault(),SessionActions.updateCurrentUser({username:this.refs.username.getDOMNode().value.trim()})},render:function(){return React.DOM.form({id:"username-select-component",className:this.visibilityClass(),onSubmit:this.submitUsername},FlashComponent({visible:this.state.error,type:"error",messages:this.errorMessage()}),React.DOM.input({name:"user[username]",id:"user_username",ref:"username",type:"text",placeholder:"pick your username"}),React.DOM.button({type:"submit"},"Finish"))}}),Menu=React.createClass({displayName:"Menu",handleLogout:function(){SessionActions.logout()},render:function(){return React.DOM.button({onClick:this.handleLogout},"logout")}}),FlashComponent=React.createClass({displayName:"FlashComponent",getInitialState:function(){return{type:this.props.type,messages:this.props.messages,visible:this.props.visible}},componentWillReceiveProps:function(t){this.setState({type:t.type,messages:t.messages,visible:t.visible})},getClasses:function(){var t=this.state.type;return this.state.visible||(t+=" hidden"),t},render:function(){var t=this.state.messages.map(function(t){return React.DOM.li(null,t)});return React.DOM.div({id:"flash-component",className:this.getClasses()},React.DOM.ul(null,t))}}),Modal=React.createClass({displayName:"Modal",maybeDismiss:function(t){t.target.id&&"scribble-modal"===t.target.id&&ModalActions.dismiss()},render:function(){return React.DOM.div({id:"scribble-modal",onClick:this.maybeDismiss},React.DOM.div({id:"scribble-modal-content"},this.props.component))}}),Bubble=React.createClass({displayName:"Bubble",getInitialState:function(){return this.props.server_rendered&&AppActions.initializeData({annotations:[this.props.annotation],comments:this.props.comments}),this.props},componentDidMount:function(){AnalyticsActions.trackAnnotationView(this.state.annotation,this.state.comments.length)},postMouseup:function(){var t={target:"bubble"};BubbleCourier.post(CourierConstants.POST_MOUSEUP,{event:t})},render:function(){return React.DOM.div({className:"bubble-component",onClick:this.postMouseup},CommentList({comments:this.state.comments,annotationId:this.props.annotation.id}))}}),Comment=React.createClass({displayName:"Comment",getInitialState:function(){return{content:this.props.comment.content,replyCount:this.props.comment.reply_count,score:this.props.comment.score,userVote:this.props.comment.current_user_vote}},componentWillReceiveProps:function(t){this.setState({content:t.comment.content,replyCount:t.comment.reply_count,score:t.comment.score,userVote:t.comment.current_user_vote})},addAnnotation:function(t){t.stopPropagation(),AnalyticsActions.trackAddAnnotation(),CommentActions.newComment(this.props.comment.annotation_id)},replyButtonText:function(){return 0===this.state.replyCount?"Reply":"Expand Replies ( "+this.state.replyCount+" )"},viewReplies:function(t){t.preventDefault(),0===this.state.replyCount?CommentActions.newReply(this.props.comment.id):CommentActions.showReplies(this.props.comment.id)},render:function(){return React.DOM.div({className:"comment-component","data-key":this.props.key},React.DOM.div({className:"votes-wrapper"},VotingBooth({score:this.state.score,userVote:this.state.userVote,commentId:this.props.comment.id})),React.DOM.div({className:"comment-content"},React.DOM.div({className:"row"},React.DOM.div({className:"small-12 column"},React.DOM.h6({className:"author"},this.props.comment.author))),React.DOM.div({className:"row"},React.DOM.div({className:"small-12 column"},React.DOM.p({className:"content"},this.state.content))),React.DOM.div({className:"comment-actions row"},React.DOM.div({className:"small-12 column"},React.DOM.div({className:"button tiny",onClick:this.addAnnotation},"Add Annotation"),React.DOM.div({className:"button tiny",onClick:this.viewReplies},this.replyButtonText())))))}}),CommentList=React.createClass({displayName:"CommentList",getInitialState:function(){return{comments:CommentStore.sortByRating(this.props.comments)}},componentWillReceiveProps:function(t){this.setState({comments:t.comments})},componentDidMount:function(){CommentStore.addChangeListener(this._onChange)},componentWillUnmount:function(){CommentStore.removeChangeListener(this._onChange)},componentDidUpdate:function(){var t;this.state.newComment&&(t=document.querySelector('.comment-component[data-key="'+this.state.newComment.id+'"]'),window.scroll(0,t.offsetTop))},collectComments:function(){return this.state.comments.map(function(t){return Comment({comment:t,key:t.id})})},render:function(){return React.DOM.div({className:"comment-list-component"},this.collectComments())},_onChange:function(){var t,e,i,s=CommentStore.getByAnnotationAsList(this.props.annotationId),n=!1;for(i=0;i<s.length;i++){for(n=!1,e=0;e<this.state.comments.length;e++)if(s[i].id===this.state.comments[e].id){n=!0;break}if(!n){t=s[i];break}}this.setState({comments:s,newComment:t})}}),VotingBooth=React.createClass({displayName:"VotingBooth",getInitialState:function(){return{score:this.props.score,userVote:this.props.userVote}},componentWillReceiveProps:function(t){return this.setState({score:t.score,userVote:t.userVote})},upVote:function(t){return t.stopPropagation(),"up"!==this.state.userVote?this.vote(!0):void 0},downVote:function(t){return t.stopPropagation(),"down"!==this.state.userVote?this.vote(!1):void 0},vote:function(t){return CommentActions.vote({id:this.props.commentId,positive:t})},voteClassName:function(t){var e="vote "+t+"-vote";return t===this.state.userVote?e+" active":e},render:function(){return React.DOM.div({className:"voting-booth-component"},React.DOM.div({className:"row"},React.DOM.div({className:"small-12 column"},React.DOM.div({className:this.voteClassName("up"),onClick:this.upVote},React.DOM.i({className:"ion-ios-play"})))),React.DOM.div({className:"row"},React.DOM.div({className:"small-12 column"},React.DOM.p({className:"vote-count"},this.state.score))),React.DOM.div({className:"row"},React.DOM.div({className:"small-12 column"},React.DOM.div({className:this.voteClassName("down"),onClick:this.downVote},React.DOM.i({className:"ion-ios-play"})))))}}),EmailSignupForm=React.createClass({displayName:"EmailSignupForm",getInitialState:function(){return{login:!1,visible:this.props.visible,error:this.props.error}},componentWillReceiveProps:function(t){this.setState({login:t.login,visible:t.visible,error:t.error})},handleEmailSubmit:function(t){t.preventDefault();var e={email:this.refs.email.getDOMNode().value.trim(),password:this.refs.password.getDOMNode().value.trim()};this.state.login?SessionActions.emailLogin(e):(e.password_confirmation=this.refs.passwordConfirmation.getDOMNode().value.trim(),SessionActions.createUserWithEmail(e))},toggleLogin:function(){this.setState({login:!this.state.login,error:!1})},visiblityClass:function(){return this.state.visible?"":"hidden"},loginClass:function(){return this.state.login?"":"hidden"},signupClass:function(){return this.state.login?"hidden":""},submitCTA:function(){return this.state.login?"Login":"Signup"},errorMessage:function(){return this.state.error?this.state.login?["Whoops! Login info doesn't match a Scribble user. Create Account instead?"]:SessionStore.userErrors():[]},toggleSocial:function(){this.props.toggleHandler()},render:function(){return React.DOM.div({className:"email-signup-form-component "+this.visiblityClass()},FlashComponent({visible:this.state.error,type:"error",messages:this.errorMessage()}),React.DOM.form({id:"email-signup-form",onSubmit:this.handleEmailSubmit},React.DOM.input({ref:"email",type:"email",id:"user_email",name:"user[email]",placeholder:"email"}),React.DOM.input({ref:"password",type:"password",id:"user_password",name:"user[password]",placeholder:"password"}),React.DOM.input({ref:"passwordConfirmation",className:this.signupClass(),type:"password",id:"user_password_confirmation",name:"user[password_confirmation]",placeholder:"password one more time"}),React.DOM.button({className:"large button",type:"submit",id:"email-form-submit"},this.submitCTA())),React.DOM.p({className:"signup-login-toggle "+this.signupClass()},"Already have an account? ",React.DOM.span({className:"clickable email-login-toggler",onClick:this.toggleLogin},"Login")),React.DOM.p({className:"signup-login-toggle "+this.loginClass()},"New to these parts? ",React.DOM.span({className:"clickable email-login-toggler",onClick:this.toggleLogin},"Signup")),React.DOM.p({className:"clickable email-form-toggle",onClick:this.toggleSocial},"or connect with Facebook or Google"))}}),FlashComponent=React.createClass({displayName:"FlashComponent",getInitialState:function(){return{type:this.props.type,messages:this.props.messages,visible:this.props.visible}},componentWillReceiveProps:function(t){this.setState({type:t.type,messages:t.messages,visible:t.visible})},getClasses:function(){var t=this.state.type;return this.state.visible||(t+=" hidden"),t},render:function(){var t=this.state.messages.map(function(t){return React.DOM.li(null,t)});return React.DOM.div({id:"flash-component",className:this.getClasses()},React.DOM.ul(null,t))}}),Janus=React.createClass({displayName:"Janus",getInitialState:function(){return this.props},componentDidMount:function(){AnalyticsActions.trackAuthStart(this.props.referringAction)},render:function(){return React.DOM.div({className:"janus-component"},LoginForm({subHeader:"Signup to "+this.state.referringAction}))}}),LoginForm=React.createClass({displayName:"LoginForm",getInitialState:function(){return null==this.props.header&&(this.props.header="Quick!"),null==this.props.subHeader&&(this.props.subHeader="Signup to post."),{emailSignup:!1,error:!1,header:this.props.header,subHeader:this.props.subHeader,username:!1}},toggleEmailForm:function(){this.setState({emailSignup:!this.state.emailSignup,error:!1})},getUsername:function(){this.setState({error:!1,header:"Last step!",subHeader:"Pick your username.",username:!0})},componentDidMount:function(){SessionStore.addChangeListener(this._onChange)},componentWillUnmount:function(){SessionStore.removeChangeListener(this._onChange)},render:function(){return React.DOM.div({className:"login-form-component"},React.DOM.div({id:"login-header"},React.DOM.h2({className:"header"},this.state.header),React.DOM.h4({className:"subheader"},this.state.subHeader)),UsernameInput({visible:this.state.username,error:this.state.error}),SocialConnectButtons({visible:!this.state.emailSignup&&!this.state.username,toggleHandler:this.toggleEmailForm}),EmailSignupForm({visible:this.state.emailSignup&&!this.state.username,toggleHandler:this.toggleEmailForm,error:this.state.error,login:!1}),React.DOM.p({className:"privacy-policy"},"we hate spam too - check out our rock solid\xa0",React.DOM.a({target:"_blank",href:scribble.helpers.routes.privacy_policy_url()},"privacy policy")))},_onChange:function(){user=SessionStore.currentUser(),user&&user.id?null==user.username&&this.getUsername():this.setState({emailSignup:this.state.emailSignup,error:!0})}}),SocialConnectButtons=React.createClass({displayName:"SocialConnectButtons",getInitialState:function(){return{visible:this.props.visible}},componentWillReceiveProps:function(t){this.setState({visible:t.visible})},handleFbLogin:function(t){t.preventDefault(),SessionActions.fbLogin()},handleGoogleLogin:function(t){t.preventDefault(),SessionActions.googleLogin()},visibilityClass:function(){return this.state.visible?"":"hidden"},render:function(){return React.DOM.div({className:"social-connect-buttons-component "+this.visibilityClass()},React.DOM.button({id:"fb-login",className:"fb-login button large",onClick:this.handleFbLogin},React.DOM.i({className:"ion-social-facebook"})," Connect With Facebook"),React.DOM.button({id:"google-login",className:"google-login button large",onClick:this.handleGoogleLogin},React.DOM.i({className:"ion-social-google"})," Connect With Google"),React.DOM.p({ref:"emailSignupLink",className:"clickable email-form-toggle",onClick:this.props.toggleHandler},"or signup with email"))}}),UsernameInput=React.createClass({displayName:"UsernameInput",getInitialState:function(){return{visible:this.props.visible,errors:this.props.error}},componentWillReceiveProps:function(t){this.setState({visible:t.visible})},visibilityClass:function(){return this.state.visible?"":"hidden"},errorMessage:function(){return this.state.error?SessionStore.userErrors():[]},submitUsername:function(t){t.preventDefault(),SessionActions.updateCurrentUser({username:this.refs.username.getDOMNode().value.trim()})},render:function(){return React.DOM.form({id:"username-select-component",className:this.visibilityClass(),onSubmit:this.submitUsername},FlashComponent({visible:this.state.error,type:"error",messages:this.errorMessage()}),React.DOM.input({name:"user[username]",id:"user_username",ref:"username",type:"text",placeholder:"pick your username"}),React.DOM.button({type:"submit",className:"button"},"Finish"))}}),AnnotationPage=React.createClass({displayName:"AnnotationPage",getInitialState:function(){return this.props.server_rendered&&AppActions.initializeData({annotations:[this.props.annotation],comments:this.props.comments}),this.props},componentDidMount:function(){AnalyticsActions.trackAnnotationView(this.state.annotation,this.state.comments.length)},commentList:function(){return CommentList({comments:this.state.comments,annotationId:this.props.annotation.id})},header:function(){return this.refs.header.getDOMNode()},submitHandler:function(t){CommentActions.createComment({annotation_id:this.props.annotation.id,comment:{content:t}})},render:function(){return React.DOM.div({className:"annotation-page-component"},React.DOM.h1({ref:"header"},React.DOM.img({src:this.props.logo})),FormVisibilityWrapper({commentList:this.commentList(),submitHandler:this.submitHandler,headerGetter:this.header,type:"comment"}))}}),Comment=React.createClass({displayName:"Comment",getInitialState:function(){return{content:this.props.comment.content,replyCount:this.props.comment.reply_count,score:this.props.comment.score,userVote:this.props.comment.current_user_vote}},componentWillReceiveProps:function(t){this.setState({content:t.comment.content,replyCount:t.comment.reply_count,score:t.comment.score,userVote:t.comment.current_user_vote})},replyButtonText:function(){return 0===this.state.replyCount?"reply":"view replies ( "+this.state.replyCount+" )"},typeClass:function(){switch(this.props.type){case"comment-header":return" comment-header";case"reply":return" reply"}return""},viewReplies:function(t){t.stopPropagation(),0===this.state.replyCount?CommentActions.newReply(this.props.comment.id):(AnalyticsActions.trackViewReplies(this.props.comment),CommentActions.showReplies(this.props.comment.id))},votingBooth:function(){return"reply"!==this.props.type?VotingBooth({score:this.state.score,userVote:this.state.userVote,commentId:this.props.comment.id}):void 0},render:function(){return React.DOM.div({className:"comment-component"+this.typeClass(),"data-key":this.props.key},React.DOM.div({className:"row"},React.DOM.div({className:"small-12 column"},this.votingBooth(),React.DOM.div({className:"avatar-wrapper"}),React.DOM.h6({className:"author"},this.props.comment.author))),React.DOM.div({className:"row"},React.DOM.div({className:"small-12 column content",dangerouslySetInnerHTML:{__html:this.state.content}})),React.DOM.div({className:"comment-actions row"},React.DOM.div({className:"small-12 column"},React.DOM.div({className:"button",onClick:this.viewReplies},this.replyButtonText()))))}}),CommentForm=React.createClass({displayName:"CommentForm",getInitialState:function(){return{visibility:this.props.visibilityStates.open,fixed:!1,firstRender:!0,submitted:!1,text:""}},componentDidMount:function(){var t=this;document.body.onmousedown=function(e){t.mouseDownE=e},document.body.onmouseup=function(){t.mouseDownE=null},CommentStore.addChangeListener(this._onChange),this.setState(this.initialMountedState())},componentWillUnmount:function(){CommentStore.removeChangeListener(this._onChange)},initialMountedState:function(){var t={firstRender:!1};return this._shouldSetFixed()&&(t.fixed=!0),t.visibility=this.props.initialState?this.props.visibilityStates[this.props.initialState]:this._shouldSetFixed()?this.props.visibilityStates.collapsed:this.props.visibilityStates.open,t},reset:function(){var t={submitted:!1,text:""};this.refs.content.getDOMNode().blur(),this.state.fixed||this._shouldSetFixed()?(t.fixed=!0,t.visibility=this.props.visibilityStates.collapsed):t.visibility=this.props.visibilityStates.open,this.setState(t),this.props.visibilityHandler(this.state.visibility)},maybeSetHeight:function(){if(this.state.visibility!==this.props.visibilityStates.expanded)return{};var t,e,i,s=this.props.headerGetter(),n=10,o=25;return t=s.offsetTop+s.clientHeight,e=2*this.refs.lowerActions.getDOMNode().clientHeight,i=window.innerHeight-t-e-n-o,{height:i+"px"}},setOpen:function(){this.state.visibility===this.props.visibilityStates.collapsed&&(this.setState({visibility:this.props.visibilityStates.open}),this.props.visibilityHandler(this.props.visibilityStates.open))},setCollapse:function(){if(!this.mouseDownE||!this.mouseDownE.target.className.match(/button/)){var t=this.refs.content.getDOMNode();this.state.fixed&&this.state.visibility===this.props.visibilityStates.open&&!t.value.trim()&&(t.value=null,this.setState({visibility:this.props.visibilityStates.collapsed}),this.props.visibilityHandler(this.props.visibilityStates.collapsed))}},setStateText:function(){this.setState({text:this.refs.content.getDOMNode().value})},submitHandler:function(t){t.preventDefault(),this.setState({submitted:!0}),this.props.submitHandler(this.state.text.trim())},toggleExpand:function(t){t.preventDefault();var e=this.state.visibility===this.props.visibilityStates.expanded?this.props.visibilityStates.open:this.props.visibilityStates.expanded;this.refs.content.getDOMNode().focus(),this.props.visibilityHandler(e),this.setState({visibility:e})},expandBtnText:function(){return this.state.visibility===this.props.visibilityStates.expanded?"Collapse Field":"Expand Field"},textAreaPlaceholder:function(){var t;return t="reply"===this.props.type?"Add reply here":"Add annotation here",this.state.visibility===this.props.visibilityStates.expanded&&(t+=". You can use markdown, if you like."),t},visibilityClasses:function(){if(this.state.firstRender)return" invisible";var t="";switch(this.state.fixed&&(t+=" fixed"),this.state.visibility){case this.props.visibilityStates.collapsed:t+=" collapsed";break;case this.props.visibilityStates.expanded:t+=" expanded"}return t},render:function(){return React.DOM.form({ref:"component",className:"comment-form-component"+this.visibilityClasses(),onSubmit:this.submitHandler},React.DOM.div({className:"actions top-actions"},React.DOM.button({className:"button alt-button",onClick:this.toggleExpand},this.expandBtnText()),React.DOM.input({type:"submit",className:"button"})),React.DOM.textarea({ref:"content",placeholder:this.textAreaPlaceholder(),onFocus:this.setOpen,style:this.maybeSetHeight(),onBlur:this.setCollapse,onChange:this.setStateText,value:this.state.text}),React.DOM.div({ref:"lowerActions",className:"actions"},React.DOM.button({className:"button alt-button",onClick:this.toggleExpand},this.expandBtnText()),React.DOM.input({type:"submit",className:"button"})))},_onChange:function(){!CommentStore.getPending()&&this.state.submitted&&this.reset()},_shouldSetFixed:function(){var t=this.refs.component.getDOMNode().getBoundingClientRect();return t.bottom>window.innerHeight}}),CommentList=React.createClass({displayName:"CommentList",getInitialState:function(){return{comments:CommentStore.sortByRating(this.props.comments)}},componentDidMount:function(){CommentStore.addChangeListener(this._onChange)},componentWillUnmount:function(){CommentStore.removeChangeListener(this._onChange)},componentDidUpdate:function(){var t;this.state.newComment&&(t=document.querySelector('.comment-component[data-key="'+this.state.newComment.id+'"]'),t&&setTimeout(function(){t.scrollIntoViewIfNeeded()},100))},collectComments:function(){return this.state.comments.map(function(t){return Comment({comment:t,key:t.id,type:"comment"})})},render:function(){return React.DOM.div({className:"comment-list-component"},this.collectComments())},_onChange:function(){var t,e,i,s=CommentStore.getByAnnotationAsList(this.props.annotationId),n=!1;for(i=0;i<s.length;i++){for(n=!1,e=0;e<this.state.comments.length;e++)if(s[i].id===this.state.comments[e].id){n=!0;break}if(!n){t=s[i];break}}this.setState({comments:CommentStore.sortByRating(s),newComment:t})}}),CommentPage=React.createClass({displayName:"CommentPage",getInitialState:function(){return this.props.server_rendered&&AppActions.initializeData({comments:this.props.replies.concat([this.props.comments])}),this.props},componentDidMount:function(){AnalyticsActions.trackViewReplies(this.props.comment)},replyList:function(){return ReplyList({comment:this.state.comment,replies:this.state.replies})},header:function(){return this.refs.header.getDOMNode()},submitHandler:function(t){CommentActions.createReply({comment_id:this.props.comment.id,reply:{content:t}})},render:function(){return React.DOM.div({className:"comment-page-component"},React.DOM.nav({ref:"header"},React.DOM.a({href:scribble.helpers.routes.annotation_path(this.props.comment.annotation_id)},"<< Back")),FormVisibilityWrapper({commentList:this.replyList(),submitHandler:this.submitHandler,headerGetter:this.header,visibility:this.props.formVisibility,type:"reply"}))}}),FormVisibilityWrapper=React.createClass({displayName:"FormVisibilityWrapper",formVisibilityStates:{collapsed:"collapsed",open:"open",expanded:"expanded"},getInitialState:function(){var t=this.props;return t.formVisibility=this.props.visibility?this.formVisibilityStates[this.props.visibility]:this.formVisibilityStates.collapsed,t},commentList:function(){return this.state.commentList?this.state.commentList:void 0},commentListVisClass:function(){return this.state.formVisibility===this.formVisibilityStates.expanded?" hidden":void 0},visibilityHandler:function(t){this.setState({formVisibility:t})},formVisibilityClass:function(){switch(this.state.formVisibility){case this.formVisibilityStates.open:return" form-open";case this.formVisibilityStates.expanded:return" form-expanded";case this.formVisibilityStates.collapsed:return" form-collapsed";default:return""
}},render:function(){return React.DOM.div({className:"form-visibility-wrapper-component"+this.formVisibilityClass()},React.DOM.div({className:"comment-list-wrapper"+this.commentListVisClass()},this.state.commentList),CommentForm({submitHandler:this.props.submitHandler,headerGetter:this.props.headerGetter,visibilityHandler:this.visibilityHandler,visibilityStates:this.formVisibilityStates,initialState:this.props.visibility,type:this.props.type}))}}),NewAnnotationPage=React.createClass({displayName:"NewAnnotationPage",componentDidMount:function(){AnalyticsActions.trackStartAnnotation(this.props.url,this.props.text.length)},header:function(){return this.refs.header.getDOMNode()},submitHandler:function(t){AnnotationActions.createWithComment({annotation:{text:this.props.text},url:this.props.url,comment:{content:t}})},render:function(){return React.DOM.div({className:"annotation-page-component"},React.DOM.h1({ref:"header"},React.DOM.img({src:this.props.logo})),FormVisibilityWrapper({submitHandler:this.submitHandler,headerGetter:this.header,visibility:"expanded",type:"comment"}))}}),ReplyList=React.createClass({displayName:"ReplyList",getInitialState:function(){return{comment:this.props.comment,replies:this.props.replies}},componentDidMount:function(){CommentStore.addChangeListener(this._onChange)},componentWillUnmount:function(){CommentStore.removeChangeListener(this._onChange)},componentDidUpdate:function(){var t;this.state.newComment&&(t=document.querySelector('.comment-component[data-key="'+this.state.newComment.id+'"]'),t&&setTimeout(function(){t.scrollIntoViewIfNeeded()},100))},collectReplies:function(){return this.state.replies.map(function(t){return Comment({comment:t,key:t.id,type:"reply"})})},render:function(){return React.DOM.div({className:"comment-list-component"},Comment({comment:this.state.comment,key:this.state.comment.id,type:"comment-header"}),this.collectReplies())},_onChange:function(){var t,e,i,s=CommentStore.getReplies(this.props.comment.id),n=!1;for(i=0;i<s.length;i++){for(n=!1,e=0;e<this.state.replies.length;e++)if(s[i].id===this.state.replies[e].id){n=!0;break}if(!n){t=s[i];break}}this.setState({comment:CommentStore.getById(this.props.comment.id),replies:s,newComment:t})}}),VotingBooth=React.createClass({displayName:"VotingBooth",getInitialState:function(){return{score:this.props.score,userVote:this.props.userVote}},componentWillReceiveProps:function(t){return this.setState({score:t.score,userVote:t.userVote})},upVote:function(t){return t.stopPropagation(),"up"!==this.state.userVote?this.vote(!0):void 0},downVote:function(t){return t.stopPropagation(),"down"!==this.state.userVote?this.vote(!1):void 0},vote:function(t){return CommentActions.vote({id:this.props.commentId,positive:t})},voteClassName:function(t){var e="vote "+t+"-vote";return t===this.state.userVote?e+" active":e},render:function(){return React.DOM.div({className:"voting-booth-component"},React.DOM.div({className:this.voteClassName("up"),onClick:this.upVote},React.DOM.i({className:"ion-ios-play"})),React.DOM.p({className:"vote-count"},this.state.score),React.DOM.div({className:this.voteClassName("down"),onClick:this.downVote},React.DOM.i({className:"ion-ios-play"})))}}),CommentForm=React.createClass({displayName:"CommentForm",submitHandler:function(t){t.preventDefault(),this.props.submitHandler(this.refs.content.getDOMNode().value)},render:function(){return React.DOM.form({className:"comment-form-component",onSubmit:this.submitHandler},React.DOM.div({className:"row"},React.DOM.div({className:"small-12 column"},React.DOM.textarea({rows:"6",ref:"content"}))),React.DOM.div({className:"row actions"},React.DOM.div({className:"small-12 column"},React.DOM.input({type:"submit",className:"button tiny"}))))}}),Paper=React.createClass({displayName:"Paper",getInitialState:function(){return this.props},componentDidMount:function(){switch(this.props.type){case"comment":AnalyticsActions.trackStartAnnotation(this.props.location,!1);break;case"annotation":AnalyticsActions.trackStartAnnotation(this.props.location,!0);break;case"reply":AnalyticsActions.trackStartReply(this.props.location)}scribble.helpers.analytics.trackGoogleEvent()},submitHandler:function(t){switch(this.props.type){case"comment":CommentActions.createComment({annotation_id:this.props.id,comment:{content:t}});break;case"annotation":AnnotationActions.createWithComment({annotation:{text:this.props.text},url:this.props.url,comment:{content:t}});break;case"reply":CommentActions.createReply({comment_id:this.props.id,reply:{content:t}})}},postMouseup:function(){var t={target:"paper"};PaperCourier.post(CourierConstants.POST_MOUSEUP,{event:t})},render:function(){return React.DOM.div({className:"paper-component",onClick:this.postMouseup},CommentForm({submitHandler:this.submitHandler}))}});